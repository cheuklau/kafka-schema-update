# Kafka Broker and Confluent Schema Registry Upgrade

## Overview

We want to perform the following upgrades concurrently:
- Kafka v0.11 to v1.0.11
- Confluent Schema Registry v3.1.1 to v5.0.1
We want to use the latest version of the Schema Registry because it supports all security features [1] and can run without Zookeeper.

## Verifications
 
We want to verify backwards compatibility to ensure older clients can talk to newer brokers [2]. Specifically, we want to test if the following clients can talk to broker v1.0.1:
- v0.10.2.0
- v0.10.2.1
- v0.10.2.2
- v0.11.0.0
- v0.11.0.1
- v0.11.0.2
- v0.11.0.3
- v1.0.0
- v1.0.1

In addition to verifying backwards compatibility, we want to test if Confluent Schema Registry v5.0.1 without Zookeeper is compatible with Kafka v1.0.1. After the above criterion are met, we want to develop a migration strategy.
 
## Testing Strategy
 
We can perform the following to meet the above verifications:
- Start Kafka/Zookeeper v1.0.1 and Confluent Schema Registry v5.0.1 without Zookeeper
    * `cd /path/to/kafka_2.11-1.0.1`
    * `bin/zookeeper-server-start.sh config/zookeeper.properties`
    * `bin/kafka-server-start.sh config/server.properties`
    * `cd /path/to/confluent-5.0.1`
    * `vi etc/schema-registry/schema-registry.properties` and perform the following:
        + Comment out `kafkastore.connection.url=localhost:2181`
        + Uncomment `kafkastore.bootstrap.sercers=PLAINTEXT://localhost:9092` 
    * `bin/schema-registry-start etc/schema-registry/schema-registry.properties`
- For each Kafka client version we want to test:
    * Update `kafka.version` in `pom.xml` to selected Kafka client version
    * Update `topic` in `all_types_test_producer.java` to `topic-<kafka-client-version>`
    * Update `topic` in `all_types_test_consumer.java` to `topic-<kafka-client-version>`
    * Update `name` in `all_types.avsc` to `AllTypes-<kafka-client-version>`
    * Rebuild Java project (`clean` then `package`)
    * Run Kafka producer to produce a new schema (see below for Avro types tested) and record
    * Run Kafka consumer to consume the record
    * Verify producer correctly sent record in terminal output
    * Verify schema is correctly registered `curl -X GET http://localhost:8081/schemas/ids/<ID>`
    * Verify consumer correctly received record in terminal output
    * Stop producer and consumer
 
 Maven dependencies and plugins:
- org.apache.avro/avro v1.8.2 (latest)
- io.confluent/kafka-avro-serializer v5.0.1 (latest) 
- org.apache.maven.plugins/maven-compiler-plugin v3.8.0 (latest)
- org.apache.avro/avro-maven-plugin v1.8.2 (latest)
- org.codehaus.mojo/build-helper-maven-plugin v3.0.0 (latest)

## Avro Types Tested
 
The primitive data types tested:
- null
- boolean
- int
- long
- float
- string
 
The complex data types tested:
- enum
- array
- union

## Testing Results

For each version, we show the Kafka producer and consumer console output along with the schema generated by the Confluent Registry Schema API:
- v0.10.2.0
```
ProducerRecord(topic=topic01020, partition=null, key=null, value={"null_test": null, "boolean_test": true, "int_test": 0, "long_test": 0, "float_test": 0.0, "string_test": "foo", "enum_test": "enum1", "array_test": ["array", "of", "strings"], "union_test": "not a null"}, timestamp=null)
topic01020-0@0

{"null_test": null, "boolean_test": true, "int_test": 0, "long_test": 0, "float_test": 0.0, "string_test": "foo", "enum_test": "enum1", "array_test": ["array", "of", "strings"], "union_test": "not a null"}

{"schema":"{\"type\":\"record\",\"name\":\"AllTypes01020\",\"namespace\":\"kafka_schema_test\",\"fields\":[{\"name\":\"null_test\",\"type\":\"null\",\"doc\":\"test primitive type null\",\"default\":null},{\"name\":\"boolean_test\",\"type\":\"boolean\",\"doc\":\"test primitive type boolean\",\"default\":true},{\"name\":\"int_test\",\"type\":\"int\",\"doc\":\"test primitive type integer\",\"default\":0},{\"name\":\"long_test\",\"type\":\"long\",\"doc\":\"test primitive type long\",\"default\":0},{\"name\":\"float_test\",\"type\":\"float\",\"doc\":\"test primitive type float\",\"default\":0.0},{\"name\":\"string_test\",\"type\":{\"type\":\"string\",\"avro.java.string\":\"String\"},\"doc\":\"test primitive type string\",\"default\":\"foo\"},{\"name\":\"enum_test\",\"type\":{\"type\":\"enum\",\"name\":\"enum_test\",\"symbols\":[\"enum1\",\"enum2\",\"enum3\"]},\"doc\":\"test complex type enum\",\"default\":\"enum1\"},{\"name\":\"array_test\",\"type\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"avro.java.string\":\"String\"}},\"doc\":\"test complex type array\",\"default\":[\"default\",\"array\",\"of\",\"strings\"]},{\"name\":\"union_test\",\"type\":[\"null\",{\"type\":\"string\",\"avro.java.string\":\"String\"}],\"doc\":\"test complex type null\",\"default\":null}]}"}
```
- v0.10.2.1
```
ProducerRecord(topic=topic01021, partition=null, key=null, value={"null_test": null, "boolean_test": true, "int_test": 0, "long_test": 0, "float_test": 0.0, "string_test": "foo", "enum_test": "enum1", "array_test": ["array", "of", "strings"], "union_test": "not a null"}, timestamp=null)
topic01021-0@0

{"null_test": null, "boolean_test": true, "int_test": 0, "long_test": 0, "float_test": 0.0, "string_test": "foo", "enum_test": "enum1", "array_test": ["array", "of", "strings"], "union_test": "not a null"}

{"schema":"{\"type\":\"record\",\"name\":\"AllTypes01021\",\"namespace\":\"kafka_schema_test\",\"fields\":[{\"name\":\"null_test\",\"type\":\"null\",\"doc\":\"test primitive type null\",\"default\":null},{\"name\":\"boolean_test\",\"type\":\"boolean\",\"doc\":\"test primitive type boolean\",\"default\":true},{\"name\":\"int_test\",\"type\":\"int\",\"doc\":\"test primitive type integer\",\"default\":0},{\"name\":\"long_test\",\"type\":\"long\",\"doc\":\"test primitive type long\",\"default\":0},{\"name\":\"float_test\",\"type\":\"float\",\"doc\":\"test primitive type float\",\"default\":0.0},{\"name\":\"string_test\",\"type\":{\"type\":\"string\",\"avro.java.string\":\"String\"},\"doc\":\"test primitive type string\",\"default\":\"foo\"},{\"name\":\"enum_test\",\"type\":{\"type\":\"enum\",\"name\":\"enum_test\",\"symbols\":[\"enum1\",\"enum2\",\"enum3\"]},\"doc\":\"test complex type enum\",\"default\":\"enum1\"},{\"name\":\"array_test\",\"type\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"avro.java.string\":\"String\"}},\"doc\":\"test complex type array\",\"default\":[\"default\",\"array\",\"of\",\"strings\"]},{\"name\":\"union_test\",\"type\":[\"null\",{\"type\":\"string\",\"avro.java.string\":\"String\"}],\"doc\":\"test complex type null\",\"default\":null}]}"}
```
- v0.10.2.2
```
ProducerRecord(topic=topic01022, partition=null, key=null, value={"null_test": null, "boolean_test": true, "int_test": 0, "long_test": 0, "float_test": 0.0, "string_test": "foo", "enum_test": "enum1", "array_test": ["array", "of", "strings"], "union_test": "not a null"}, timestamp=null)
topic01022-0@0

{"null_test": null, "boolean_test": true, "int_test": 0, "long_test": 0, "float_test": 0.0, "string_test": "foo", "enum_test": "enum1", "array_test": ["array", "of", "strings"], "union_test": "not a null"}

{"schema":"{\"type\":\"record\",\"name\":\"AllTypes01022\",\"namespace\":\"kafka_schema_test\",\"fields\":[{\"name\":\"null_test\",\"type\":\"null\",\"doc\":\"test primitive type null\",\"default\":null},{\"name\":\"boolean_test\",\"type\":\"boolean\",\"doc\":\"test primitive type boolean\",\"default\":true},{\"name\":\"int_test\",\"type\":\"int\",\"doc\":\"test primitive type integer\",\"default\":0},{\"name\":\"long_test\",\"type\":\"long\",\"doc\":\"test primitive type long\",\"default\":0},{\"name\":\"float_test\",\"type\":\"float\",\"doc\":\"test primitive type float\",\"default\":0.0},{\"name\":\"string_test\",\"type\":{\"type\":\"string\",\"avro.java.string\":\"String\"},\"doc\":\"test primitive type string\",\"default\":\"foo\"},{\"name\":\"enum_test\",\"type\":{\"type\":\"enum\",\"name\":\"enum_test\",\"symbols\":[\"enum1\",\"enum2\",\"enum3\"]},\"doc\":\"test complex type enum\",\"default\":\"enum1\"},{\"name\":\"array_test\",\"type\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"avro.java.string\":\"String\"}},\"doc\":\"test complex type array\",\"default\":[\"default\",\"array\",\"of\",\"strings\"]},{\"name\":\"union_test\",\"type\":[\"null\",{\"type\":\"string\",\"avro.java.string\":\"String\"}],\"doc\":\"test complex type null\",\"default\":null}]}"}\
```
- v0.11.0.0
```
ProducerRecord(topic=topic01100, partition=null, headers=RecordHeaders(headers = [], isReadOnly = false), key=null, value={"null_test": null, "boolean_test": true, "int_test": 0, "long_test": 0, "float_test": 0.0, "string_test": "foo", "enum_test": "enum1", "array_test": ["array", "of", "strings"], "union_test": "not a null"}, timestamp=null)
topic01100-0@0

{"null_test": null, "boolean_test": true, "int_test": 0, "long_test": 0, "float_test": 0.0, "string_test": "foo", "enum_test": "enum1", "array_test": ["array", "of", "strings"], "union_test": "not a null"}

{"schema":"{\"type\":\"record\",\"name\":\"AllTypes01100\",\"namespace\":\"kafka_schema_test\",\"fields\":[{\"name\":\"null_test\",\"type\":\"null\",\"doc\":\"test primitive type null\",\"default\":null},{\"name\":\"boolean_test\",\"type\":\"boolean\",\"doc\":\"test primitive type boolean\",\"default\":true},{\"name\":\"int_test\",\"type\":\"int\",\"doc\":\"test primitive type integer\",\"default\":0},{\"name\":\"long_test\",\"type\":\"long\",\"doc\":\"test primitive type long\",\"default\":0},{\"name\":\"float_test\",\"type\":\"float\",\"doc\":\"test primitive type float\",\"default\":0.0},{\"name\":\"string_test\",\"type\":{\"type\":\"string\",\"avro.java.string\":\"String\"},\"doc\":\"test primitive type string\",\"default\":\"foo\"},{\"name\":\"enum_test\",\"type\":{\"type\":\"enum\",\"name\":\"enum_test\",\"symbols\":[\"enum1\",\"enum2\",\"enum3\"]},\"doc\":\"test complex type enum\",\"default\":\"enum1\"},{\"name\":\"array_test\",\"type\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"avro.java.string\":\"String\"}},\"doc\":\"test complex type array\",\"default\":[\"default\",\"array\",\"of\",\"strings\"]},{\"name\":\"union_test\",\"type\":[\"null\",{\"type\":\"string\",\"avro.java.string\":\"String\"}],\"doc\":\"test complex type null\",\"default\":null}]}"}
```
- v0.11.0.1
```
ProducerRecord(topic=topic01101, partition=null, headers=RecordHeaders(headers = [], isReadOnly = false), key=null, value={"null_test": null, "boolean_test": true, "int_test": 0, "long_test": 0, "float_test": 0.0, "string_test": "foo", "enum_test": "enum1", "array_test": ["array", "of", "strings"], "union_test": "not a null"}, timestamp=null)
topic01101-0@0

{"null_test": null, "boolean_test": true, "int_test": 0, "long_test": 0, "float_test": 0.0, "string_test": "foo", "enum_test": "enum1", "array_test": ["array", "of", "strings"], "union_test": "not a null"}

{"schema":"{\"type\":\"record\",\"name\":\"AllTypes01101\",\"namespace\":\"kafka_schema_test\",\"fields\":[{\"name\":\"null_test\",\"type\":\"null\",\"doc\":\"test primitive type null\",\"default\":null},{\"name\":\"boolean_test\",\"type\":\"boolean\",\"doc\":\"test primitive type boolean\",\"default\":true},{\"name\":\"int_test\",\"type\":\"int\",\"doc\":\"test primitive type integer\",\"default\":0},{\"name\":\"long_test\",\"type\":\"long\",\"doc\":\"test primitive type long\",\"default\":0},{\"name\":\"float_test\",\"type\":\"float\",\"doc\":\"test primitive type float\",\"default\":0.0},{\"name\":\"string_test\",\"type\":{\"type\":\"string\",\"avro.java.string\":\"String\"},\"doc\":\"test primitive type string\",\"default\":\"foo\"},{\"name\":\"enum_test\",\"type\":{\"type\":\"enum\",\"name\":\"enum_test\",\"symbols\":[\"enum1\",\"enum2\",\"enum3\"]},\"doc\":\"test complex type enum\",\"default\":\"enum1\"},{\"name\":\"array_test\",\"type\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"avro.java.string\":\"String\"}},\"doc\":\"test complex type array\",\"default\":[\"default\",\"array\",\"of\",\"strings\"]},{\"name\":\"union_test\",\"type\":[\"null\",{\"type\":\"string\",\"avro.java.string\":\"String\"}],\"doc\":\"test complex type null\",\"default\":null}]}"}
```
- v0.11.0.2
```
ProducerRecord(topic=topic01102, partition=null, headers=RecordHeaders(headers = [], isReadOnly = false), key=null, value={"null_test": null, "boolean_test": true, "int_test": 0, "long_test": 0, "float_test": 0.0, "string_test": "foo", "enum_test": "enum1", "array_test": ["array", "of", "strings"], "union_test": "not a null"}, timestamp=null)
topic01102-0@0

{"null_test": null, "boolean_test": true, "int_test": 0, "long_test": 0, "float_test": 0.0, "string_test": "foo", "enum_test": "enum1", "array_test": ["array", "of", "strings"], "union_test": "not a null"}

{"schema":"{\"type\":\"record\",\"name\":\"AllTypes01102\",\"namespace\":\"kafka_schema_test\",\"fields\":[{\"name\":\"null_test\",\"type\":\"null\",\"doc\":\"test primitive type null\",\"default\":null},{\"name\":\"boolean_test\",\"type\":\"boolean\",\"doc\":\"test primitive type boolean\",\"default\":true},{\"name\":\"int_test\",\"type\":\"int\",\"doc\":\"test primitive type integer\",\"default\":0},{\"name\":\"long_test\",\"type\":\"long\",\"doc\":\"test primitive type long\",\"default\":0},{\"name\":\"float_test\",\"type\":\"float\",\"doc\":\"test primitive type float\",\"default\":0.0},{\"name\":\"string_test\",\"type\":{\"type\":\"string\",\"avro.java.string\":\"String\"},\"doc\":\"test primitive type string\",\"default\":\"foo\"},{\"name\":\"enum_test\",\"type\":{\"type\":\"enum\",\"name\":\"enum_test\",\"symbols\":[\"enum1\",\"enum2\",\"enum3\"]},\"doc\":\"test complex type enum\",\"default\":\"enum1\"},{\"name\":\"array_test\",\"type\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"avro.java.string\":\"String\"}},\"doc\":\"test complex type array\",\"default\":[\"default\",\"array\",\"of\",\"strings\"]},{\"name\":\"union_test\",\"type\":[\"null\",{\"type\":\"string\",\"avro.java.string\":\"String\"}],\"doc\":\"test complex type null\",\"default\":null}]}"}
```
- v0.11.0.3
```
ProducerRecord(topic=topic01103, partition=null, headers=RecordHeaders(headers = [], isReadOnly = false), key=null, value={"null_test": null, "boolean_test": true, "int_test": 0, "long_test": 0, "float_test": 0.0, "string_test": "foo", "enum_test": "enum1", "array_test": ["array", "of", "strings"], "union_test": "not a null"}, timestamp=null)
topic01103-0@0

{"null_test": null, "boolean_test": true, "int_test": 0, "long_test": 0, "float_test": 0.0, "string_test": "foo", "enum_test": "enum1", "array_test": ["array", "of", "strings"], "union_test": "not a null"}

{"schema":"{\"type\":\"record\",\"name\":\"AllTypes01103\",\"namespace\":\"kafka_schema_test\",\"fields\":[{\"name\":\"null_test\",\"type\":\"null\",\"doc\":\"test primitive type null\",\"default\":null},{\"name\":\"boolean_test\",\"type\":\"boolean\",\"doc\":\"test primitive type boolean\",\"default\":true},{\"name\":\"int_test\",\"type\":\"int\",\"doc\":\"test primitive type integer\",\"default\":0},{\"name\":\"long_test\",\"type\":\"long\",\"doc\":\"test primitive type long\",\"default\":0},{\"name\":\"float_test\",\"type\":\"float\",\"doc\":\"test primitive type float\",\"default\":0.0},{\"name\":\"string_test\",\"type\":{\"type\":\"string\",\"avro.java.string\":\"String\"},\"doc\":\"test primitive type string\",\"default\":\"foo\"},{\"name\":\"enum_test\",\"type\":{\"type\":\"enum\",\"name\":\"enum_test\",\"symbols\":[\"enum1\",\"enum2\",\"enum3\"]},\"doc\":\"test complex type enum\",\"default\":\"enum1\"},{\"name\":\"array_test\",\"type\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"avro.java.string\":\"String\"}},\"doc\":\"test complex type array\",\"default\":[\"default\",\"array\",\"of\",\"strings\"]},{\"name\":\"union_test\",\"type\":[\"null\",{\"type\":\"string\",\"avro.java.string\":\"String\"}],\"doc\":\"test complex type null\",\"default\":null}]}"}
```
- v1.0.0
```
ProducerRecord(topic=topic100, partition=null, headers=RecordHeaders(headers = [], isReadOnly = false), key=null, value={"null_test": null, "boolean_test": true, "int_test": 0, "long_test": 0, "float_test": 0.0, "string_test": "foo", "enum_test": "enum1", "array_test": ["array", "of", "strings"], "union_test": "not a null"}, timestamp=null)
topic100-0@0

{"null_test": null, "boolean_test": true, "int_test": 0, "long_test": 0, "float_test": 0.0, "string_test": "foo", "enum_test": "enum1", "array_test": ["array", "of", "strings"], "union_test": "not a null"}

{"schema":"{\"type\":\"record\",\"name\":\"AllTypes100\",\"namespace\":\"kafka_schema_test\",\"fields\":[{\"name\":\"null_test\",\"type\":\"null\",\"doc\":\"test primitive type null\",\"default\":null},{\"name\":\"boolean_test\",\"type\":\"boolean\",\"doc\":\"test primitive type boolean\",\"default\":true},{\"name\":\"int_test\",\"type\":\"int\",\"doc\":\"test primitive type integer\",\"default\":0},{\"name\":\"long_test\",\"type\":\"long\",\"doc\":\"test primitive type long\",\"default\":0},{\"name\":\"float_test\",\"type\":\"float\",\"doc\":\"test primitive type float\",\"default\":0.0},{\"name\":\"string_test\",\"type\":{\"type\":\"string\",\"avro.java.string\":\"String\"},\"doc\":\"test primitive type string\",\"default\":\"foo\"},{\"name\":\"enum_test\",\"type\":{\"type\":\"enum\",\"name\":\"enum_test\",\"symbols\":[\"enum1\",\"enum2\",\"enum3\"]},\"doc\":\"test complex type enum\",\"default\":\"enum1\"},{\"name\":\"array_test\",\"type\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"avro.java.string\":\"String\"}},\"doc\":\"test complex type array\",\"default\":[\"default\",\"array\",\"of\",\"strings\"]},{\"name\":\"union_test\",\"type\":[\"null\",{\"type\":\"string\",\"avro.java.string\":\"String\"}],\"doc\":\"test complex type null\",\"default\":null}]}"}
```
- v1.0.1
```
ProducerRecord(topic=topic101, partition=null, headers=RecordHeaders(headers = [], isReadOnly = false), key=null, value={"null_test": null, "boolean_test": true, "int_test": 0, "long_test": 0, "float_test": 0.0, "string_test": "foo", "enum_test": "enum1", "array_test": ["array", "of", "strings"], "union_test": "not a null"}, timestamp=null)
topic101-0@0

{"null_test": null, "boolean_test": true, "int_test": 0, "long_test": 0, "float_test": 0.0, "string_test": "foo", "enum_test": "enum1", "array_test": ["array", "of", "strings"], "union_test": "not a null"}

{"schema":"{\"type\":\"record\",\"name\":\"AllTypes101\",\"namespace\":\"kafka_schema_test\",\"fields\":[{\"name\":\"null_test\",\"type\":\"null\",\"doc\":\"test primitive type null\",\"default\":null},{\"name\":\"boolean_test\",\"type\":\"boolean\",\"doc\":\"test primitive type boolean\",\"default\":true},{\"name\":\"int_test\",\"type\":\"int\",\"doc\":\"test primitive type integer\",\"default\":0},{\"name\":\"long_test\",\"type\":\"long\",\"doc\":\"test primitive type long\",\"default\":0},{\"name\":\"float_test\",\"type\":\"float\",\"doc\":\"test primitive type float\",\"default\":0.0},{\"name\":\"string_test\",\"type\":{\"type\":\"string\",\"avro.java.string\":\"String\"},\"doc\":\"test primitive type string\",\"default\":\"foo\"},{\"name\":\"enum_test\",\"type\":{\"type\":\"enum\",\"name\":\"enum_test\",\"symbols\":[\"enum1\",\"enum2\",\"enum3\"]},\"doc\":\"test complex type enum\",\"default\":\"enum1\"},{\"name\":\"array_test\",\"type\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"avro.java.string\":\"String\"}},\"doc\":\"test complex type array\",\"default\":[\"default\",\"array\",\"of\",\"strings\"]},{\"name\":\"union_test\",\"type\":[\"null\",{\"type\":\"string\",\"avro.java.string\":\"String\"}],\"doc\":\"test complex type null\",\"default\":null}]}"}
```
The results show that Kafka Client v0.10.2.0 to v1.0.1 can properly communicate with Kafka Broker v1.0.1 using Confluent Schema Registry v5.0.1 at least within the subset of our Java producer and consumer examples.

## Migration Strategies
 
### Strategy 1: Kafka + Schema Registry Downtime
 
To migrate with Kafka and Schema Registry downtime:
- Shutdown all Kafka v0.11 servers
- Shutdown Schema Registry v3.1.1 servers
- Startup Kafka v1.0.1 servers
- Startup Schema Registry v5.0.1 servers without Zookeeper
 
What do we need to test:
- Kafka v0.11 already runs with Schema Registry v3.1.1 in production
- We already verified that Kafka v1.0.1 can run with Schema Registry v5.0.1 for Kafka clients v0.10.0.2 to v1.0.1
- There is no intermediate configuration since all servers are shutdown simultaneously
- We should still test if the records and schemas stored before the upgrade are available after the upgrade

Testing results:
- Started Kafka v0.11.0 and Confluent Schema Registry v3.1.1 using Zookeeper
- Used Producer v0.10.2.0 to generate a schema and record
- Verified Producer produced correct record using console output:
```
ProducerRecord(topic=topic01020, partition=null, key=null, value={"null_test": null, "boolean_test": true, "int_test": 0, "long_test": 0, "float_test": 0.0, "string_test": "foo", "enum_test": "enum1", "array_test": ["array", "of", "strings"], "union_test": "not a null"}, timestamp=null)
topic01020-0@0
```
- Verified schema properly recorded:
```
{"schema":"{\"type\":\"record\",\"name\":\"AllTypes01020\",\"namespace\":\"kafka_schema_test\",\"fields\":[{\"name\":\"null_test\",\"type\":\"null\",\"doc\":\"test primitive type null\",\"default\":null},{\"name\":\"boolean_test\",\"type\":\"boolean\",\"doc\":\"test primitive type boolean\",\"default\":true},{\"name\":\"int_test\",\"type\":\"int\",\"doc\":\"test primitive type integer\",\"default\":0},{\"name\":\"long_test\",\"type\":\"long\",\"doc\":\"test primitive type long\",\"default\":0},{\"name\":\"float_test\",\"type\":\"float\",\"doc\":\"test primitive type float\",\"default\":0.0},{\"name\":\"string_test\",\"type\":{\"type\":\"string\",\"avro.java.string\":\"String\"},\"doc\":\"test primitive type string\",\"default\":\"foo\"},{\"name\":\"enum_test\",\"type\":{\"type\":\"enum\",\"name\":\"enum_test\",\"symbols\":[\"enum1\",\"enum2\",\"enum3\"]},\"doc\":\"test complex type enum\",\"default\":\"enum1\"},{\"name\":\"array_test\",\"type\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"avro.java.string\":\"String\"}},\"doc\":\"test complex type array\",\"default\":[\"default\",\"array\",\"of\",\"strings\"]},{\"name\":\"union_test\",\"type\":[\"null\",{\"type\":\"string\",\"avro.java.string\":\"String\"}],\"doc\":\"test complex type null\",\"default\":null}]}"}
```
- Used Consumer v0.10.2.0 to consume a record
- Verified Consumer consumed correct record using console output:
```
{"null_test": null, "boolean_test": true, "int_test": 0, "long_test": 0, "float_test": 0.0, "string_test": "foo", "enum_test": "enum1", "array_test": ["array", "of", "strings"], "union_test": "not a null"}
```
- Shutdown Kafka v0.11.0 and Confluent Schema Registry v3.1.1
- Started Kafka v1.0.1 and Confluent Schema Registry v5.0.1
- Verified schema is still available:
```
{"schema":"{\"type\":\"record\",\"name\":\"AllTypes01020\",\"namespace\":\"kafka_schema_test\",\"fields\":[{\"name\":\"null_test\",\"type\":\"null\",\"doc\":\"test primitive type null\",\"default\":null},{\"name\":\"boolean_test\",\"type\":\"boolean\",\"doc\":\"test primitive type boolean\",\"default\":true},{\"name\":\"int_test\",\"type\":\"int\",\"doc\":\"test primitive type integer\",\"default\":0},{\"name\":\"long_test\",\"type\":\"long\",\"doc\":\"test primitive type long\",\"default\":0},{\"name\":\"float_test\",\"type\":\"float\",\"doc\":\"test primitive type float\",\"default\":0.0},{\"name\":\"string_test\",\"type\":{\"type\":\"string\",\"avro.java.string\":\"String\"},\"doc\":\"test primitive type string\",\"default\":\"foo\"},{\"name\":\"enum_test\",\"type\":{\"type\":\"enum\",\"name\":\"enum_test\",\"symbols\":[\"enum1\",\"enum2\",\"enum3\"]},\"doc\":\"test complex type enum\",\"default\":\"enum1\"},{\"name\":\"array_test\",\"type\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"avro.java.string\":\"String\"}},\"doc\":\"test complex type array\",\"default\":[\"default\",\"array\",\"of\",\"strings\"]},{\"name\":\"union_test\",\"type\":[\"null\",{\"type\":\"string\",\"avro.java.string\":\"String\"}],\"doc\":\"test complex type null\",\"default\":null}]}"}
```
- Used Producer v0.10.2.0 to produce another record
- Verified Producer produced correct record using console output (note offset increment):
```
ProducerRecord(topic=topic01020, partition=null, key=null, value={"null_test": null, "boolean_test": true, "int_test": 0, "long_test": 0, "float_test": 0.0, "string_test": "foo", "enum_test": "enum1", "array_test": ["array", "of", "strings"], "union_test": "not a null"}, timestamp=null)
topic01020-0@1
```
- Used Consumer v0.10.2.0 to consume a record
- Verified Consumer consumed correct record using console output:
```
{"null_test": null, "boolean_test": true, "int_test": 0, "long_test": 0, "float_test": 0.0, "string_test": "foo", "enum_test": "enum1", "array_test": ["array", "of", "strings"], "union_test": "not a null"}
```

### Strategy 2: Schema Registry Downtime
 
To migrate with only Schema Registry downtime:
- Rolling upgrade of Kafka v0.11 to v1.0.1
- Shutdown Schema Registry v3.1.1 servers
- Startup Schema Registry v5.0.1 servers without Zookeeper
 
What do we need to test:
- We already showed that Kafka is backwards compatible so rolling upgrade should not cause downtime [2]
- We cannot perform a rolling upgrade of the Schema Registry (see below); therefore downtime is required to upgrade
    * From `schema-registry.properties`: Note that you cannot mix the two modes (with and without Zookeeper); use this mode (without Zookeeper) only on new deployments or by shutting down all instances, switching to the new configuration and then starting the Schema registry instances again.
- We already showed that records and schemas generated before the upgrade are available after the upgrade
- No additional tests required.

## Sources
 
1. https://docs.confluent.io/current/schema-registry/docs/security.html
2. https://www.confluent.io/blog/upgrading-apache-kafka-clients-just-got-easier/
3. https://docs.confluent.io/current/schema-registry/docs/deployment.html#schemaregistry-zk-migration